<p-dialog
  [header]="title()"
  [visible]="visible()"
  (visibleChange)="$event ? null : onDialogHide()"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="generic-form-dialog"
  [style]="{ width: '540px' }"
>
  @if (form(); as fg) {
    <form
      [formGroup]="fg"
      (ngSubmit)="onSave()"
      class="generic-form"
      autocomplete="off"
      novalidate
    >
      @for (row of fieldRows(); track $index) {
        @if (row.length > 1) {
          <!-- Multi-column row -->
          <div class="form-row">
            @for (field of row; track field.key) {
              <ng-container
                *ngTemplateOutlet="fieldTpl; context: { $implicit: field }"
              />
            }
          </div>
        } @else {
          <!-- Single-column field -->
          <ng-container
            *ngTemplateOutlet="fieldTpl; context: { $implicit: row[0] }"
          />
        }
      }

      <!-- Extra projected content (e.g. a preview section) -->
      <ng-content />

      <!-- ── Field template ─────────────────────────────────────── -->
      <!-- Declared INSIDE [formGroup] so formControlName directives  -->
      <!-- can resolve ControlContainer at the declaration site.      -->
      <ng-template #fieldTpl let-field>
        <div class="form-group">
          <label [for]="'gfd-' + field.key" class="form-label">
            {{ field.label }}
            @if (field.required) {
              <span class="required" aria-hidden="true">*</span>
            }
          </label>

          @switch (field.type) {

            <!-- text -->
            @case ('text') {
              <input
                pInputText
                [id]="'gfd-' + field.key"
                [formControlName]="field.key"
                [placeholder]="field.placeholder ?? ''"
                class="w-full"
                autocomplete="off"
                [class.ng-invalid]="isFieldInvalid(field.key)"
                [attr.aria-invalid]="isFieldInvalid(field.key)"
                [attr.aria-required]="field.required ?? false"
              />
            }

            <!-- textarea -->
            @case ('textarea') {
              <textarea
                pTextarea
                [id]="'gfd-' + field.key"
                [formControlName]="field.key"
                [placeholder]="field.placeholder ?? ''"
                class="w-full"
                [rows]="field.rows ?? 3"
                [autoResize]="true"
                autocomplete="off"
              ></textarea>
            }

            <!-- select -->
            @case ('select') {
              <p-select
                [inputId]="'gfd-' + field.key"
                [formControlName]="field.key"
                [options]="field.options ?? []"
                optionLabel="label"
                optionValue="value"
                [placeholder]="field.placeholder ?? 'Choisir…'"
                styleClass="w-full"
                appendTo="body"
                [class.ng-invalid]="isFieldInvalid(field.key)"
                [attr.aria-required]="field.required ?? false"
              />
            }

            <!-- color -->
            @case ('color') {
              <p-inputgroup class="w-full">
                <p-inputgroup-addon>
                  <p-colorpicker
                    [ngModel]="colorPickerValues()[field.key] || '1976D2'"
                    (ngModelChange)="onColorPickerChange(field.key, $event)"
                    [ngModelOptions]="{ standalone: true }"
                    [inline]="false"
                    appendTo="body"
                    [attr.aria-label]="'Sélecteur de couleur pour ' + field.label"
                  />
                </p-inputgroup-addon>
                <input
                  pInputText
                  [id]="'gfd-' + field.key"
                  [formControlName]="field.key"
                  [placeholder]="field.placeholder ?? '#RRGGBB'"
                  [class.ng-invalid]="isFieldInvalid(field.key)"
                  [attr.aria-invalid]="isFieldInvalid(field.key)"
                  [attr.aria-required]="field.required ?? false"
                  [attr.aria-label]="'Valeur hexadécimale pour ' + field.label"
                />
              </p-inputgroup>
            }

            <!-- number -->
            @case ('number') {
              <p-inputnumber
                [inputId]="'gfd-' + field.key"
                [formControlName]="field.key"
                [placeholder]="field.placeholder ?? ''"
                [min]="field.min"
                [max]="field.max"
                [step]="field.step ?? 1"
                styleClass="w-full"
                [inputStyleClass]="isFieldInvalid(field.key) ? 'ng-invalid' : ''"
                [attr.aria-required]="field.required ?? false"
              />
            }

            <!-- date -->
            @case ('date') {
              <p-datepicker
                [inputId]="'gfd-' + field.key"
                [formControlName]="field.key"
                [placeholder]="field.placeholder ?? 'jj/mm/aaaa'"
                dateFormat="dd/mm/yy"
                [showIcon]="true"
                appendTo="body"
                styleClass="w-full"
                [inputStyleClass]="isFieldInvalid(field.key) ? 'ng-invalid w-full' : 'w-full'"
                [attr.aria-required]="field.required ?? false"
              />
            }

            <!-- checkbox -->
            @case ('checkbox') {
              <div class="checkbox-wrapper">
                <p-checkbox
                  [formControlName]="field.key"
                  [binary]="true"
                  [inputId]="'gfd-' + field.key"
                />
                <label [for]="'gfd-' + field.key" class="checkbox-label">
                  {{ field.placeholder ?? field.label }}
                </label>
              </div>
            }

            <!-- radio -->
            @case ('radio') {
              <div class="radio-group" role="radiogroup" [attr.aria-labelledby]="'gfd-lbl-' + field.key">
                @for (opt of (field.options ?? []); track opt.value) {
                  <div class="radio-option">
                    <p-radiobutton
                      [formControlName]="field.key"
                      [inputId]="'gfd-' + field.key + '-' + opt.value"
                      [value]="opt.value"
                    />
                    <label [for]="'gfd-' + field.key + '-' + opt.value">{{ opt.label }}</label>
                  </div>
                }
              </div>
            }

          }

          @if (isFieldInvalid(field.key)) {
            <small class="field-error" role="alert">{{ getFieldError(field.key) }}</small>
          }
        </div>
      </ng-template>
    </form>
  }

  <ng-template pTemplate="footer">
    <div class="dialog-footer">
      <p-button
        label="Annuler"
        icon="pi pi-times"
        [outlined]="true"
        severity="secondary"
        (onClick)="onCancel()"
      />
      <p-button
        [label]="saveLabel()"
        [icon]="'pi ' + saveIcon()"
        [loading]="saving()"
        (onClick)="onSave()"
      />
    </div>
  </ng-template>
</p-dialog>
